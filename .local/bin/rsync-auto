#!/usr/bin/env bash

# ================== é…ç½®åŒº ==================
LOG_FILE="$PWD/sync-auto.log"

if [ $# -lt 1 ]; then
    echo -e "\033[31mâŒ ç”¨æ³•: $0 <è¿œç¨‹ä¸»æœºå> [æœ¬åœ°ç›®å½•] [è¿œç¨‹ç›®å½•]\033[0m"
    echo "   æœ¬åœ°ç›®å½•é»˜è®¤: $DEFAULT_LOCAL_DIR"
    echo "   è¿œç¨‹ç›®å½•é»˜è®¤: $DEFAULT_REMOTE_DIR"
    exit 1
fi

REMOTE_HOSTNAME="$1"
LOCAL_DIR="${2}"
REMOTE_DIR="${3}"

# Rsync æ’é™¤åˆ—è¡¨ (æ•°ç»„æ ¼å¼ï¼Œæ›´å®‰å…¨)
EXCLUDES=(
    "--exclude=.git/"
    "--exclude=node_modules/"
    "--exclude=__pycache__/"
    "--exclude=.DS_Store"
    "--exclude=*.swp"
    "--exclude=.vscode/"
)

if [ $# -lt 1 ]; then
    echo -e "\033[31mâŒ ç”¨æ³•: $0 <è¿œç¨‹ä¸»æœºå> [æœ¬åœ°ç›®å½•] [è¿œç¨‹ç›®å½•]\033[0m"
    echo "   ç¤ºä¾‹: $0 user@server /home/user/project /remote/project"
    exit 1
fi

# Rsync å¸¸ç”¨é€‰é¡¹
# -a: å½’æ¡£æ¨¡å¼
# -z: å‹ç¼©ä¼ è¾“
# --delete: åˆ é™¤è¿œç¨‹æœ‰å¤šä½™çš„æ–‡ä»¶
# -no- --no-owner --no-group: å¿½ç•¥æƒé™/ç”¨æˆ·ç»„å·®å¼‚ï¼ˆé¿å…æƒé™ä¸è¶³æŠ¥é”™ï¼‰
RSYNC_OPTS=(-avz --delete --no-owner --no-group)

# ================== åŠŸèƒ½å‡½æ•° ==================

# ç»Ÿä¸€æ—¥å¿—å‡½æ•°ï¼šç»ˆç«¯å¸¦é¢œè‰²ï¼Œæ–‡ä»¶ä¸å¸¦é¢œè‰²
log() {
    local level="$1"
    local msg="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local color_start=""
    local color_end="\033[0m"

    case "$level" in
        INFO)    color_start="\033[36m" ;; # é’è‰²
        SUCCESS) color_start="\033[32m" ;; # ç»¿è‰²
        WARN)    color_start="\033[33m" ;; # é»„è‰²
        ERROR)   color_start="\033[31m" ;; # çº¢è‰²
    esac

    # 1. è¾“å‡ºåˆ°ç»ˆç«¯ (å¸¦é¢œè‰²)
    echo -e "${color_start}[${timestamp}] [${level}] ${msg}${color_end}"

    # 2. è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ (å»é™¤é¢œè‰²ä»£ç )
    # å¦‚æœä¸æƒ³ç”¨ sed å»é™¤é¢œè‰²ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ†å¼€å†™ï¼Œè¿™é‡Œä¸ºäº†ä¿æŒå†…å®¹ä¸€è‡´æ€§ç›´æ¥å­˜çº¯æ–‡æœ¬
    echo "[${timestamp}] [${level}] ${msg}" >> "$LOG_FILE"
}

# æ£€æŸ¥ä¾èµ–
check_dependency() {
    if ! command -v fswatch &> /dev/null; then
        log "ERROR" "æœªæ‰¾åˆ° fswatchï¼Œè¯·å…ˆå®‰è£… (brew install fswatch æˆ– apt install fswatch)"
        exit 1
    fi

    if [ ! -d "$LOCAL_DIR" ]; then
        log "ERROR" "æœ¬åœ°ç›®å½•ä¸å­˜åœ¨: $LOCAL_DIR"
        exit 1
    fi
}

# æµ‹è¯• SSH è¿æ¥
check_connection() {
    log "INFO" "æ­£åœ¨æµ‹è¯•ä¸ $REMOTE_HOSTNAME çš„è¿æ¥..."
    if ssh -q -o BatchMode=yes -o ConnectTimeout=5 "$REMOTE_HOSTNAME" exit; then
        log "SUCCESS" "SSH è¿æ¥æ­£å¸¸"
    else
        log "ERROR" "æ— æ³•è¿æ¥åˆ°è¿œç¨‹ä¸»æœº $REMOTE_HOSTNAMEï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– SSH é…ç½®ã€‚"
        exit 1
    fi
}

# åŒæ­¥æ ¸å¿ƒé€»è¾‘
sync_to_remote() {
    local trigger_reason="$1"

    log "INFO" ">>> å¼€å§‹åŒæ­¥ (è§¦å‘: $trigger_reason)"
    echo -e "\033[36m--- å˜æ›´æ–‡ä»¶ ---\033[0m"

    # æ ¸å¿ƒï¼šrsync -> stderrè½¬stdout -> tee(å†™æ–‡ä»¶) -> grep(è¿‡æ»¤å±å¹•æ˜¾ç¤º)
    rsync "${RSYNC_OPTS[@]}" "${EXCLUDES[@]}" "$LOCAL_DIR" "$REMOTE_HOSTNAME:$REMOTE_DIR" \
        2>&1 \
        | tee -a "$LOG_FILE" \
        | grep -vE '^sending incremental file list$|^$|^sent [0-9,]+ bytes|^total size is'

    # è·å–ç®¡é“é“¾ä¸­ç¬¬ä¸€ä¸ªå‘½ä»¤(rsync)çš„é€€å‡ºç 
    local rsync_status=${PIPESTATUS[0]}

    if [ $rsync_status -eq 0 ]; then
        log "SUCCESS" "åŒæ­¥å®Œæˆ"
    else
        echo -e "\033[36m----------------\033[0m"
        log "ERROR" "åŒæ­¥å¤±è´¥ (Code: $rsync_status) - è¯¦æƒ…è§æ—¥å¿—"
    fi
}

# é€€å‡ºæ¸…ç†
cleanup() {
    echo ""
    log "WARN" "ğŸ›‘ æœåŠ¡å·²åœæ­¢"
    exit 0
}
trap cleanup INT TERM

# ================== ä¸»ç¨‹åº ==================

check_dependency
check_connection

echo "========================================"
echo "ğŸš€ è‡ªåŠ¨åŒæ­¥æœåŠ¡å·²å¯åŠ¨"
echo "ğŸ“‚ æœ¬åœ°ç›®å½•: $LOCAL_DIR"
echo "ğŸ“¡ è¿œç¨‹ç›®æ ‡: $REMOTE_HOSTNAME:$REMOTE_DIR"
echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo "========================================"

# é¦–æ¬¡å…¨é‡åŒæ­¥
sync_to_remote "é¦–æ¬¡å¯åŠ¨"

log "INFO" "æ­£åœ¨ç›‘å¬æ–‡ä»¶å˜æ›´..."

# ç›‘å¬å¾ªç¯
# -o: è¾“å‡ºå˜æ›´äº‹ä»¶æ•°é‡
# -l 1: å»¶è¿Ÿ 1 ç§’
# -r: é€’å½’
# --event ...: ä¹Ÿå¯ä»¥æŒ‡å®šåªç›‘å¬ Updated, Created, Removed ç­‰ï¼Œè¿™é‡Œé»˜è®¤å…¨ç›‘å¬
fswatch -o -l 1 -r "$LOCAL_DIR"\
    --event Created --event Updated --event Removed --event Renamed --event MovedTo --event MovedFrom \
    | while read num; do
    sync_to_remote "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
done
