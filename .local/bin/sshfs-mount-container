#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/_sshfs_lib"

set -e

# ======================
# å¸®åŠ©ä¿¡æ¯
# ======================
show_help() {
    cat <<EOF
ç”¨æ³•: $0 [é€‰é¡¹] <ssh_info> <container_name> <mount_point>

å‚æ•°:
  ssh_info       è¿œç¨‹ä¸»æœºçš„ SSH åœ°å€ï¼Œä¾‹å¦‚: user@host
  container_name è¿œç¨‹ Docker å®¹å™¨åæˆ– ID
  mount_point    æœ¬åœ°æŒ‚è½½ç›®å½•ï¼ˆå°†è¢«åˆ›å»ºå¦‚ä¸å­˜åœ¨ï¼‰

é€‰é¡¹:
  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©

ç¤ºä¾‹:
  $0 user@192.168.1.10 my_container /mnt/remote_container
EOF
}

# ======================
# å‚æ•°è§£æ
# ======================
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

if [[ $# -ne 3 ]]; then
    echo "é”™è¯¯ï¼šéœ€è¦ 3 ä¸ªå‚æ•°" >&2
    show_help
    exit 1
fi

SSH_INFO="$1"
CONTAINER_NAME="$2"
MOUNT_POINT="$3"

# ======================
# å‚æ•°æ ¡éªŒ
# ======================
if [[ -z "$SSH_INFO" || -z "$CONTAINER_NAME" || -z "$MOUNT_POINT" ]]; then
    echo "é”™è¯¯ï¼šå‚æ•°ä¸èƒ½ä¸ºç©º" >&2
    exit 1
fi

MOUNT_POINT="${MOUNT_POINT%/}"  # å»é™¤æœ«å°¾æ–œæ 

if [[ ! -d "$MOUNT_POINT" ]]; then
    echo "æŒ‚è½½ç‚¹ $MOUNT_POINT ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
    mkdir -p "$MOUNT_POINT"
    # chmod 755 "$MOUNT_POINT"
fi

# ======================
# è·å–è¿œç¨‹å®¹å™¨çš„ bind mounts
# ======================
echo "æ­£åœ¨é€šè¿‡ SSH æŸ¥è¯¢å®¹å™¨ $CONTAINER_NAME çš„ bind mounts..."

# æ„é€  docker inspect å‘½ä»¤ï¼Œåªè¾“å‡º bind mounts çš„ Source å’Œ Destination
# æ ¼å¼ï¼š/host/path:/container/path
MOUNTS_RAW=$(ssh "$SSH_INFO" "docker inspect -f '{{range \$m := .Mounts}}{{if eq \$m.Type \"bind\"}}{{\$m.Source}}:{{\$m.Destination}}{{println}}{{end}}{{end}}' '$CONTAINER_NAME'")

if [[ -z "$MOUNTS_RAW" ]]; then
    echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• bind mountsï¼ˆå¯èƒ½åªæœ‰ volumes æˆ–å®¹å™¨ä¸å­˜åœ¨ï¼‰"
    exit 1
fi

echo "æ£€æµ‹åˆ°ä»¥ä¸‹ bind mountsï¼š"
echo "$MOUNTS_RAW"

# ======================
# æŒ‚è½½æ¯ä¸ªè·¯å¾„
# ======================
# è½¬æ¢ä¸ºæ•°ç»„ï¼ˆæŒ‰è¡Œåˆ†å‰²ï¼‰
mapfile -t MOUNT_PAIRS <<< "$MOUNTS_RAW"

echo "å¼€å§‹æŒ‚è½½åˆ°æœ¬åœ°å­ç›®å½•..."

for pair in "${MOUNT_PAIRS[@]}"; do
    if [[ -z "$pair" ]]; then
        continue
    fi

    # æ‹†åˆ† Source å’Œ Destination
    IFS=':' read -r REMOTE_SOURCE REMOTE_DEST <<< "$pair"

    # ä¸ºå®¹å™¨å†…è·¯å¾„ç”Ÿæˆæœ¬åœ°å­ç›®å½•åï¼ˆé¿å… / å¼€å¤´ï¼Œç”¨ basename æˆ–æ›¿æ¢ / ä¸º _ï¼‰
    # ç®€å•åšæ³•ï¼šå–æœ€åä¸€æ®µï¼ˆå¦‚ /workspace/pcb_vlm â†’ pcb_vlmï¼‰
    SUBDIR_NAME=$(basename "$REMOTE_DEST")

    # å¦‚æœå¤šä¸ª mount æœ‰ç›¸åŒ basenameï¼Œå¯è€ƒè™‘ç”¨å®Œæ•´è·¯å¾„å“ˆå¸Œï¼Œä½†å…ˆç”¨ basename
    LOCAL_SUBDIR="$MOUNT_POINT/$SUBDIR_NAME"

    # å¦‚æœå­ç›®å½•å·²å­˜åœ¨ä½†éç©ºï¼Œè·³è¿‡æˆ–æŠ¥é”™ï¼ˆä¿å®ˆèµ·è§ï¼šè·³è¿‡ï¼‰
    if [[ -e "$LOCAL_SUBDIR" ]]; then
        if [[ -d "$LOCAL_SUBDIR" && -n "$(ls -A "$LOCAL_SUBDIR" 2>/dev/null)" ]]; then
            echo "âš ï¸ è·³è¿‡ $REMOTE_SOURCE â†’ $LOCAL_SUBDIRï¼ˆéç©ºï¼‰"
            continue
        fi
    else
        mkdir -p "$LOCAL_SUBDIR"
    fi

    echo "æŒ‚è½½ $SSH_INFO:$REMOTE_SOURCE â†’ $LOCAL_SUBDIR"

    sshfs_mount "$SSH_INFO:$REMOTE_SOURCE" "$LOCAL_SUBDIR"

    echo "âœ… æŒ‚è½½æˆåŠŸ: $LOCAL_SUBDIR"
done

echo ""
echo "ğŸ“Œ æŒ‚è½½å®Œæˆï¼æ‰€æœ‰å­ç›®å½•ä½äº: $MOUNT_POINT"
echo "ğŸ’¡ ä½¿ç”¨å®Œæ¯•åï¼Œè¯·ä¾æ¬¡å¸è½½ï¼š"
for pair in "${MOUNT_PAIRS[@]}"; do
    [[ -z "$pair" ]] && continue
    REMOTE_DEST=$(cut -d':' -f2 <<< "$pair")
    SUBDIR_NAME=$(basename "$REMOTE_DEST")
    LOCAL_SUBDIR="$MOUNT_POINT/$SUBDIR_NAME"
    echo "  sudo umount '$LOCAL_SUBDIR'"
done
